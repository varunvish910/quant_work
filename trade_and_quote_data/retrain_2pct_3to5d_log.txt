================================================================================
ğŸ¯ RETRAINING EARLY WARNING MODEL
================================================================================

New Target: 2%+ pullback within 3-5 days
(Much tighter, more actionable signal)

================================================================================
STEP 1: LOADING DATA
================================================================================

ğŸ“¥ Loading SPY data from 2000-01-01 to 2024-12-31...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $50.09 - $600.51
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
âœ… SPY data loaded: 6288 records
ğŸ“¥ Loading 10 sector ETFs...
   Loading XLU (Utilities)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $6.84 - $80.56
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLU loaded
   Loading XLK (Technology)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $8.64 - $239.92
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLK loaded
   Loading XLV (Healthcare)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $14.91 - $153.91
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLV loaded
   Loading XLF (Financials)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $3.71 - $50.60
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLF loaded
   Loading XLE (Energy)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $10.51 - $94.14
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLE loaded
   Loading XLI (Industrials)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $11.10 - $141.81
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLI loaded
   Loading XLY (Consumer Discretionary)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $13.03 - $237.40
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLY loaded
   Loading XLP (Consumer Staples)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $10.06 - $81.62
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLP loaded
   Loading XLB (Materials)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $9.79 - $95.72
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… XLB loaded
   Loading XLRE (Real Estate)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $19.51 - $45.64
âœ… Data validation passed: 2322 records from 2015-10-08 to 2024-12-30
   âœ… XLRE loaded
âœ… Loaded 10/10 sector ETFs
ğŸ“¥ Loading 4 rotation indicators...
   Loading MAGS (Magnificent 7)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $24.00 - $57.79
âœ… Data validation passed: 434 records from 2023-04-11 to 2024-12-30
   âœ… MAGS loaded
   Loading RSP (Equal Weight S&P 500)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $15.64 - $184.51
âœ… Data validation passed: 5454 records from 2003-05-01 to 2024-12-30
   âœ… RSP loaded
   Loading QQQ (Nasdaq 100)...
ğŸ” Validating data source: yfinance
   âŒ Failed to load QQQ: âŒ FORBIDDEN: Unrealistic price range 16.97-535.28 for ROTATION_ETF (expected 10-500)
   âš ï¸  Continuing without QQQ
   Loading QQQE (Equal Weight Nasdaq 100)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $15.12 - $95.64
âœ… Data validation passed: 3215 records from 2012-03-21 to 2024-12-30
   âœ… QQQE loaded
âœ… Loaded 3/4 rotation indicators
ğŸ’± Loading currency data...
   Loading USDJPY (JPY=X)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $75.74 - $161.62
âœ… Data validation passed: 6492 records from 2000-01-03 to 2024-12-30
   âœ… USDJPY loaded
   Loading EURUSD (EURUSD=X)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $0.96 - $1.60
âœ… Data validation passed: 5472 records from 2003-12-01 to 2024-12-30
   âœ… EURUSD loaded
   Loading DXY (UUP)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $18.08 - $29.37
âœ… Data validation passed: 4490 records from 2007-03-01 to 2024-12-30
   âœ… DXY loaded
âœ… Loaded 3/3 currency pairs
ğŸ“Š Loading volatility data...
   Loading VIX (^VIX)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $9.14 - $82.69
âœ… Data validation passed: 6288 records from 2000-01-03 to 2024-12-30
   âœ… VIX loaded
   Loading VIX9D (^VIX9D)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $7.10 - $106.66
âœ… Data validation passed: 3521 records from 2011-01-03 to 2024-12-30
   âœ… VIX9D loaded
   Loading VVIX (^VVIX)...
ğŸ” Validating data source: yfinance
   ğŸ“Š Price range: $59.74 - $207.59
âœ… Data validation passed: 4520 records from 2007-01-03 to 2024-12-30
   âœ… VVIX loaded
âœ… Loaded 3/3 volatility indices
âœ… Loaded 6288 days of SPY data

================================================================================
STEP 2: CREATING FEATURES
================================================================================

================================================================================
ğŸ”§ CALCULATING FEATURES
================================================================================
Feature sets: baseline, currency, volatility
ğŸ“Š Calculating baseline features...
   âœ… Rotation indicators: 3 features
   âœ… Regime detection: 11 features
   âœ… Momentum exhaustion: 9 features
   âœ… Baseline features: 31
ğŸ’± Calculating currency features...
   âœ… Currency features: 12
ğŸ“Š Calculating volatility features...
   âœ… Volatility features: 19
ğŸ§¹ Cleaning features...
   Dropped 20 rows with missing critical features
   âœ… Clean data: 6268 records with 62 features
================================================================================
âœ… FEATURE CALCULATION COMPLETE: 62 features
================================================================================
âœ… Created 92 features

================================================================================
STEP 3: CREATING TARGET
================================================================================

ğŸ¯ Creating Early Warning Target
   Drawdown threshold: 2.0%
   Lead time: 3-5 days
   Lookforward window: 5 days
ğŸ¯ EARLY_WARNING TARGET CREATED
   Total samples: 6,263
   Positive samples: 2,307 (36.8%)
   Negative samples: 3,956 (63.2%)
   Class balance: 0.58 (1.0 = perfect balance)

================================================================================
STEP 4: PREPARING TRAINING DATA
================================================================================

Training:   2000-02-01 to 2022-12-30
            5767 samples, 2182 positive (37.8%)

Validation: 2023-01-03 to 2023-12-29
            250 samples, 67 positive (26.8%)

Test:       2024-01-02 to 2024-12-20
            246 samples, 58 positive (23.6%)

================================================================================
STEP 5: TRAINING MODEL
================================================================================

ğŸ”„ Training LightGBM model with class balancing...
âœ… Training complete

================================================================================
STEP 6: EVALUATING ON 2024 DATA
================================================================================

ğŸ“Š ROC AUC: 67.3%

Confusion Matrix:
                Predicted No    Predicted Yes
Actual No            165              23
Actual Yes            37              21

Metrics:
  Precision: 47.73% (When we predict pullback, how often is it real?)
  Recall:    36.21% (Of all real pullbacks, how many did we catch?)
  F1 Score:  41.18%

================================================================================
ğŸ¯ TESTING ON KEY 2024 DRAWDOWN DATES
================================================================================

ğŸ“… April 1, 2024
   SPY: $512.66
   Model probability: 40.2%
   Verdict: âœ… LOW RISK
   Reality: âŒ No 2%+ pullback within 3-5 days

ğŸ“… July 15, 2024
   SPY: $553.09
   Model probability: 45.3%
   Verdict: âœ… LOW RISK
   Reality: âœ… 2%+ pullback did occur within 3-5 days

ğŸ“… October 16, 2024
   SPY: $575.31
   Model probability: 41.7%
   Verdict: âœ… LOW RISK
   Reality: âŒ No 2%+ pullback within 3-5 days

ğŸ“… December 5, 2024
   SPY: $599.37
   Model probability: 41.8%
   Verdict: âœ… LOW RISK
   Reality: âŒ No 2%+ pullback within 3-5 days

================================================================================
ğŸ“Š HIGH CONFIDENCE SIGNALS IN 2024
================================================================================

Threshold 50%+:
  Total signals: 44
  True positives: 21 (correct)
  False positives: 23 (false alarm)
  Precision: 47.7%

Threshold 60%+:
  Total signals: 11
  True positives: 6 (correct)
  False positives: 5 (false alarm)
  Precision: 54.5%

================================================================================
ğŸ’¾ SAVING MODEL AND RESULTS
================================================================================

âœ… Saved model: models/trained/early_warning_2pct_3to5d.txt
âœ… Saved feature config: models/trained/early_warning_2pct_3to5d_features.json
âœ… Saved 2024 predictions: output/2024_predictions_2pct_3to5d.csv

================================================================================
âœ… RETRAINING COMPLETE
================================================================================

Model Performance on 2024:
  ROC AUC: 67.3%
Traceback (most recent call last):
  File "/Users/varun/code/quant_final_final/trade_and_quote_data/retrain_2pct_3to5days.py", line 321, in <module>
    print(f"  Recall: {recall:.1%} (caught {tp}/{tp+fn} events)")
                                                 ~~^~~
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/ops/common.py", line 76, in new_method
    return method(self, other)
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/arraylike.py", line 186, in __add__
    return self._arith_method(other, operator.add)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/frame.py", line 7913, in _arith_method
    new_data = self._dispatch_frame_op(other, op, axis=axis)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/frame.py", line 7945, in _dispatch_frame_op
    bm = self._mgr.apply(array_op, right=right)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/internals/managers.py", line 361, in apply
    applied = b.apply(f, **kwargs)
              ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/internals/blocks.py", line 393, in apply
    result = func(self.values, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/ops/array_ops.py", line 273, in arithmetic_op
    res_values = op(left, right)
                 ^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/ops/common.py", line 76, in new_method
    return method(self, other)
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pandas/core/arrays/datetimelike.py", line 1383, in __add__
    raise integer_op_not_supported(self)
TypeError: Addition/subtraction of integers and integer-arrays with DatetimeArray is no longer supported.  Instead of adding/subtracting `n`, use `n * obj.freq`
